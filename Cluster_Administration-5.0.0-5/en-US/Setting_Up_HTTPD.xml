<?xml version='1.0'?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN" "http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd" [
<!ENTITY % RH_ENTITIES SYSTEM "./Common_Config/rh-entities.ent">
%RH_ENTITIES;
]>

<chapter id="ch-httpd-service">
	<title>Setting Up &HTTPD;</title>
	<para>
		 This chapter contains instructions for configuring &PROD; to make the &HTTPD; highly available. 
	</para>
	<indexterm>
		
		<primary>cluster services</primary>
		<secondary>&HTTPD;, setting up</secondary>
	</indexterm>
	<indexterm>
		
		<primary>&HTTPD;</primary>
		<secondary>setting up service</secondary>
	</indexterm>
	<indexterm>
		
		<primary>HTTP services</primary>
		<secondary>&HTTPD;</secondary>
		<tertiary>setting up</tertiary>
	</indexterm>
	<para>
		 The following is an example of setting up a cluster service that fails over an &HTTPD;. Although the actual variables used in the service depend on the specific configuration, the example may assist in setting up a service for a particular environment. 
	</para>
	<section id="s1-apache-setup">
		<title>&HTTPD; Setup Overview</title>
		<para>
			 First, configure &HTTPD; on all nodes in the cluster. If using a failover domain , assign the service to all cluster nodes configured to run the &HTTPD;. Refer to <xref linkend="s1-config-failover-domain" /> for instructions. The cluster software ensures that only one cluster system runs the &HTTPD; at one time. The example configuration consists of installing the <filename>httpd</filename> RPM package on all cluster nodes (or on nodes in the failover domain, if used) and configuring a shared GFS shared resource for the Web content. 
		</para>
		<para>
			 When installing the &HTTPD; on the cluster systems, run the following command to ensure that the cluster nodes do not automatically start the service when the system boots: 
		</para>
		<screen><command>chkconfig --del httpd</command></screen><para>
			 Rather than having the system init scripts spawn the <command>httpd</command> daemon, the cluster infrastructure initializes the service on the active cluster node. This ensures that the corresponding IP address and file system mounts are active on only one cluster node at a time. 
		</para>
		<para>
			 When adding an <filename>httpd</filename> service, a <firstterm>floating</firstterm> IP address must be assigned to the service so that the IP address will transfer from one cluster node to another in the event of failover or service relocation. The cluster infrastructure binds this IP address to the network interface on the cluster system that is currently running the &HTTPD;. This IP address ensures that the cluster node running <filename>httpd</filename> is transparent to the clients accessing the service. 
		</para>
		<para>
			 The file systems that contain the Web content cannot be automatically mounted on the shared storage resource when the cluster nodes boot. Instead, the cluster software must mount and unmount the file system as the <filename>httpd</filename> service is started and stopped. This prevents the cluster systems from accessing the same data simultaneously, which may result in data corruption. Therefore, do not include the file systems in the <filename>/etc/fstab</filename> file. 
		</para>
	</section>
	<section id="s1-apache-sharedfs">
		<title>Configuring Shared Storage</title>
		<para>
			 To set up the shared file system resource, perform the following tasks as root on one cluster system: 
		</para>
		<orderedlist>
			<listitem>
				<para>
					 On one cluster node, use the interactive <command>parted</command> utility to create a partition to use for the document root directory. Note that it is possible to create multiple document root directories on different disk partitions. 
				</para>
			</listitem>
			<listitem>
				<para>
					 Use the <command>mkfs</command> command to create an ext3 file system on the partition you created in the previous step. Specify the drive letter and the partition number. For example: 
				</para>
				<screen>mkfs -t ext3 /dev/sde3</screen>
			</listitem>
			<listitem>
				<para>
					 Mount the file system that contains the document root directory. For example: 
				</para>
				<screen><command>mount /dev/sde3 /var/www/html</command></screen><para>
					 Do not add this mount information to the <filename>/etc/fstab</filename> file because only the cluster software can mount and unmount file systems used in a service. 
				</para>
			</listitem>
			<listitem>
				<para>
					 Copy all the required files to the document root directory. 
				</para>
			</listitem>
			<listitem>
				<para>
					 If you have CGI files or other files that must be in different directories or in separate partitions, repeat these steps, as needed. 
				</para>
			</listitem>
		</orderedlist>
	</section>
	<section id="s1-apache-inshttpd">
		<title>Installing and Configuring the &HTTPD;</title>
		<para>
			 The &HTTPD; must be installed and configured on all nodes in the assigned failover domain, if used, or in the cluster. The basic server configuration must be the same on all nodes on which it runs for the service to fail over correctly. The following example shows a basic &HTTPD; installation that includes no third-party modules or performance tuning. 
		</para>
		<para>
			 On all node in the cluster (or nodes in the failover domain, if used), install the <filename>httpd</filename> RPM package. For example: 
		</para>
		<screen><command>rpm -Uvh httpd-<replaceable>&lt;version&gt;</replaceable>.<replaceable>&lt;arch&gt;</replaceable>.rpm</command></screen><indexterm>
			
			<primary>&HTTPD;</primary>
			<secondary><filename>httpd.conf</filename></secondary>
		</indexterm>
		<indexterm>
			
			<primary>cluster services</primary>
			<secondary>&HTTPD;, setting up</secondary>
			<tertiary><filename>httpd.conf</filename></tertiary>
		</indexterm>
		<indexterm>
			
			<primary>HTTP services</primary>
			<secondary>&HTTPD;</secondary>
			<tertiary>httpd.conf</tertiary>
		</indexterm>
		<para>
			 To configure the &HTTPD; as a cluster service, perform the following tasks: 
		</para>
		<orderedlist>
			<listitem>
				<para>
					 Edit the <filename>/etc/httpd/conf/httpd.conf</filename> configuration file and customize the file according to your configuration. For example: 
				</para>
				<itemizedlist>
					<listitem>
						<para>
							 Specify the directory that contains the HTML files. Also specify this mount point when adding the service to the cluster configuration. It is only required to change this field if the mountpoint for the website's content differs from the default setting of <filename>/var/www/html/</filename>. For example: 
						</para>
						<screen><computeroutput>DocumentRoot &#34;/mnt/httpdservice/html&#34; </computeroutput></screen>
					</listitem>
					<listitem>
						<para>
							 Specify a unique IP address to which the service will listen for requests. For example: 
						</para>
						<screen><computeroutput>Listen 192.168.1.100:80 </computeroutput></screen><para>
							 This IP address then must be configured as a cluster resource for the service using the <application>&RHCLUSTERTOOL;</application>. 
						</para>
					</listitem>
					<listitem>
						<para>
							 If the script directory resides in a non-standard location, specify the directory that contains the CGI programs. For example: 
						</para>
						<screen><computeroutput>ScriptAlias /cgi-bin/ &#34;/mnt/httpdservice/cgi-bin/&#34; </computeroutput></screen>
					</listitem>
					<listitem>
						<para>
							 Specify the path that was used in the previous step, and set the access permissions to default to that directory. For example: 
						</para>
						<screen><computeroutput>&lt;Directory /mnt/httpdservice/cgi-bin&#34;&gt; AllowOverride None Options None Order allow,deny Allow from all &lt;/Directory&gt; </computeroutput></screen><para>
							 Additional changes may need to be made to tune the &HTTPD; or add module functionality. For information on setting up other options, refer to the <citetitle>&RHELSAG;</citetitle> and the <citetitle>&RHELRG;</citetitle>. 
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					 The standard &HTTPD; start script, <filename>/etc/rc.d/init.d/httpd</filename> is also used within the cluster framework to start and stop the &HTTPD; on the active cluster node. Accordingly, when configuring the service, specify this script by adding it as a <guilabel>Script</guilabel> resource in the <application>&RHCLUSTERTOOL;</application>. 
				</para>
			</listitem>
			<listitem>
				<para>
					 Copy the configuration file over to the other nodes of the cluster (or nodes of the failover domain, if configured). 
				</para>
			</listitem>
		</orderedlist>
		<para>
			 Before the service is added to the cluster configuration, ensure that the &HTTPD; directories are not mounted. Then, on one node, invoke the <application>&RHCLUSTERTOOL;</application> to add the service, as follows. This example assumes a failover domain named <filename>httpd-domain</filename> was created for this service. 
		</para>
		<orderedlist>
			<listitem>
				<para>
					 Add the init script for the &HTTPD; service. 
				</para>
				<itemizedlist>
					<listitem>
						<para>
							 Select the <guilabel>Resources</guilabel> tab and click <guibutton>Create a Resource</guibutton>. The <guilabel>Resources Configureation</guilabel> properties dialog box is displayed. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Select <guilabel>Script</guilabel> form the drop down menu. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Enter a <guilabel>Name</guilabel> to be associated with the &HTTPD; service. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Specify the path to the &HTTPD; init script (for example, 
							<userinput>/etc/rc.d/init.d/httpd</userinput>) in the <guilabel>File (with path)</guilabel> field. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Click <guibutton>OK</guibutton>. 
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					 Add a device for the &HTTPD; content files and/or custom scripts. 
				</para>
				<itemizedlist>
					<listitem>
						<para>
							 Click <guibutton>Create a Resource</guibutton>. 
						</para>
					</listitem>
					<listitem>
						<para>
							 In the <guilabel>Resource Configuration</guilabel> dialog, select <guilabel>File System</guilabel> from the drop-down menu. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Enter the <guilabel>Name</guilabel> for the resource (for example, 
							<userinput>httpd-content</userinput>. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Choose <guilabel>ext3</guilabel> from the <guilabel>File System Type</guilabel> drop-down menu. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Enter the mount point in the <guilabel>Mount Point</guilabel> field (for example, 
							<userinput>/var/www/html/</userinput>). 
						</para>
					</listitem>
					<listitem>
						<para>
							 Enter the device special file name in the <guilabel>Device</guilabel> field (for example, 
							<userinput>/dev/sda3</userinput>). 
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					 Add an IP address for the &HTTPD; service. 
				</para>
				<itemizedlist>
					<listitem>
						<para>
							 Click <guibutton>Create a Resource</guibutton>. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Choose <guilabel>IP Address</guilabel> from the drop-down menu. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Enter the <guilabel>IP Address</guilabel> to be associatged with the &HTTPD; service. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Make sure that the <guilabel>Monitor Link</guilabel> checkbox is left checked. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Click <guibutton>OK</guibutton>. 
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					 Click the <guilabel>Services</guilabel> property. 
				</para>
			</listitem>
			<listitem>
				<para>
					 Create the &HTTPD; service. 
				</para>
				<itemizedlist>
					<listitem>
						<para>
							 Click <guibutton>Create a Service</guibutton>. Type a <guilabel>Name</guilabel> for the service in the <guilabel>Add a Service</guilabel> dialog. 
						</para>
					</listitem>
					<listitem>
						<para>
							 In the <guilabel>Service Management</guilabel> dialog, select a <guilabel>Failover Domain</guilabel> from the drop-down menu or leave it as <guilabel>None</guilabel>. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Click the <guibutton>Add a Shared Resource to this service</guibutton> button. From the available list, choose each resource that you created in the previous steps. Repeat this step until all resources have been added. 
						</para>
					</listitem>
					<listitem>
						<para>
							 Click <guibutton>OK</guibutton>. 
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					 Choose <guimenu>File</guimenu>=&gt; <guimenuitem>Save</guimenuitem> to save your changes. 
				</para>
			</listitem>
		</orderedlist>
	</section>
</chapter>

